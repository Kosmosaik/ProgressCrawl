# ProgressCrawl – Zone Exploration QoL Branch (Pre–0.0.70d)

This document summarizes the **Zone Exploration Quality-of-Life changes** implemented in this branch before continuing with **0.0.70d – Dynamic Events System**. It is meant as a handoff / technical summary for the next GPT assistant and for future maintenance.

> Scope: Focused on **zone exploration feel & UX** – character marker, movement, exploration animation/timing, and smarter tile selection.  
> Status: **Partially complete**. Several QoL points are implemented; others remain as clear TODOs (see bottom).

---

## 1. High-Level Goals for This QoL Branch

Original user goals for this pre–0.0.70d branch:

1. Add a **character sprite/symbol** on the zone grid (`☺`) that moves as the player explores.
2. Add a **blinking animation** to the tile currently being explored (the next tile to be revealed).
3. Improve exploration from simple sequential reveal toward a **more natural/random walk**, avoiding obvious “scanline” behavior.
4. Prepare for additional QoL changes such as view distance, better handling of locked tiles, and coordinate system tweaks.

This branch does **not** introduce new content, enemies, or resources. It strictly improves the *feel* of moving through a zone.

---

## 2. Current Exploration Flow (Conceptual)

The exploration pipeline now has these phases for each step (both **manual** and **auto**):

1. **Choose target tile**  
   - `ZoneDebug.prepareNextExplorationTile(zone)` selects a target `?` tile and stores it as:
     - `zone.preparedTargetX`
     - `zone.preparedTargetY`
   - Tile is *not* immediately revealed or blinking at this stage.

2. **Pathfinding & movement**  
   - `findPathToPreparedTile(zone)` (in `game.js`) computes a path so the character can **walk over explored tiles** to a **stance tile next to the target**, not onto the target itself.
   - Movement is executed via:
     - `startZoneMovement(path, onArrival)`  
       This moves one tile at a time at a configurable **tiles-per-second speed**, updating `hasPlayer` on the tiles and re-rendering the UI.
   - The movement finishes when the character stands **adjacent** to the target `?` tile.

3. **Exploration delay ("studying the tile")**  
   - When the character reaches the stance tile, we start an **exploration delay**:
     - `startZoneExploreDelay(onReveal)`
   - This will:
     - Clear any previous `isActiveExplore` flags.
     - Mark the **target tile** as `tile.isActiveExplore = true` so it **blinks**.
     - Start a timer (currently 1–3 seconds) representing **“exploring this tile”**.

4. **Reveal tile + move onto it**  
   - When the delay ends, `runZoneExplorationTick()` calls:
     - `revealNextTileWithMessageAndUI()` → which prefers:
       - `ZoneDebug.revealPreparedExplorationTile(zone)` (uses the prepared tile)
       - falling back to `revealNextExplorableTileSequential(zone)` if needed.
   - `revealPreparedExplorationTile(zone)`:
     - Sets `tile.isActiveExplore = false` (stop blinking).
     - Marks the target `tile.explored = true`.
     - Moves the **player marker onto the tile**:
       - Clears `hasPlayer` on all tiles.
       - Sets `tile.hasPlayer = true` on the newly explored tile.

5. **Auto exploration loop**  
   - For auto mode, `scheduleNextZoneExplorationTick()` and `beginZoneExplorationCycle()` coordinate:
     - Pick target → pathfind → walk → exploration delay → reveal → repeat,
     - Until the zone is fully explored.

Result: the character visibly **walks through the explored part** of the map, pauses **next to** the target tile while it’s being explored (blinking `?`), and only then steps onto the now-explored `.` tile.

---

## 3. Data & State Changes

### 3.1. Tile structure enhancements

Each zone tile now may use these flags:
- `tile.explored: boolean`  
- `tile.kind: "walkable" | "blocked" | "locked"`  
- `tile.hasPlayer: boolean` – the character sprite’s position in the zone.  
- `tile.isActiveExplore: boolean` – **only one tile** at a time should have this true; it marks the **tile currently being explored / blinking**.

### 3.2. Zone object fields

On the `zone` object (in addition to existing fields):

- `zone.playerX` / `zone.playerY` – coarse player position (legacy tracking; current movement actually uses `tile.hasPlayer`).
- `zone.preparedTargetX` / `zone.preparedTargetY` – coordinates of the **next tile to explore**, chosen by `prepareNextExplorationTile`.

These are set/reset inside `zones.core.js` helpers and are consumed by `game.js` exploration logic.

---

## 4. Zone Core Helpers (zones.core.js)

### 4.1. Player & active-tile helpers

- `clearZonePlayerMarker(zone)`  
  Clears all `tile.hasPlayer = false` in the zone.

- `clearTileActiveExploreFlags(zone)`  
  Clears all `tile.isActiveExplore = false`. Ensures only one tile blink at a time.

- `findZonePlayerPosition(zone)`  
  Returns `{ x, y }` of the tile where `hasPlayer` is true, or `null` if not yet set.

- `tileHasExploredOrPlayerNeighbor(zone, x, y)`  
  Used to define a “frontier”: a tile is in the frontier if at least one 4-direction neighbor is explored or contains the player. This keeps exploration **organic** around known territory.

### 4.2. Target selection: `prepareNextExplorationTile(zone)`

This is the **high-level “AI” for exploration direction**:

Priority:

1. **Neighbor of player**  
   - Try to pick an unexplored, explorable tile directly next to the player (4-dir neighbors).
   - If found, pick a random one and set:
     - `zone.preparedTargetX`
     - `zone.preparedTargetY`  
   - No blinking yet; just selection.

2. **Frontier tiles**  
   - If no neighbor is available, gather all unexplored tiles that have an explored/player neighbor (frontier).
   - If any frontier tiles exist, pick a random one and store its coordinates as target.

3. **Fallback tiles**  
   - As a last resort, pick from remaining unexplored explorable tiles.

Return value: `true` if a target was chosen, `false` if nothing is left to explore.

### 4.3. Reveal helpers

- `revealPreparedExplorationTile(zone)`  
  - Searches for the tile currently marked with `isActiveExplore && !explored`.
  - If found:
    - Stops blinking (`isActiveExplore = false`),
    - Marks as explored (`explored = true`),
    - Moves player marker (`clearZonePlayerMarker` then `hasPlayer = true` there).
  - If none is found (fallback case), calls `revealNextExplorableTileSequential(zone)`.

- `revealNextExplorableTileSequential(zone)`  
  - Legacy behavior: top-left to bottom-right scan, reveal first unexplored, explorable tile; move player there.
  - Kept as fallback and for debugging.

### 4.4. Zone debug API

`window.ZoneDebug` exposes:

- `createDebugZone`
- `createZoneFromDefinition`
- `getZoneExplorationStats`
- `revealNextExplorableTileSequential`
- `prepareNextExplorationTile`
- `revealPreparedExplorationTile`
- `ensureGeneratedZoneDefinitionForWorldTile`

These are used by `game.js` and are handy for future debugging in the browser console.

---

## 5. Game-Level Exploration Logic (game.js)

### 5.1. Movement state

New movement-related globals:

```js
let zoneMovementActive = false;
let zoneMovementTimerId = null;
let zoneMovementPath = null;
let zoneMovementOnArrival = null;

const ZONE_MOVEMENT_TILES_PER_SECOND =
  (GAME_CONFIG.zone && GAME_CONFIG.zone.movementTilesPerSecond) || 4;
```

- Movement speed is configurable via `GAME_CONFIG.zone.movementTilesPerSecond`.
- Movement is tile-based, driven by `setTimeout` steps.

### 5.2. Player position & movement

- `setZonePlayerPosition(zone, x, y)`  
  Sets `tile.hasPlayer` true on the given coordinates and false on all others.

- `findPlayerPositionInZone(zone)`  
  Same role as `findZonePlayerPosition` in `zones.core.js`, but kept in `game.js` to drive movement/pathfinding from the game layer.

- `startZoneMovement(path, onArrival)`  
  - Walks along the `path` array (`[{x,y}, ...]`), one tile at a time.
  - After each step, calls `setZonePlayerPosition` and `renderZoneUI()`.
  - Step interval is computed from `ZONE_MOVEMENT_TILES_PER_SECOND`.
  - When path is exhausted, calls `onArrival()`.

- `stopZoneMovement()`  
  - Clears timer, resets movement state.

### 5.3. Pathfinding: `findPathToPreparedTile(zone)`

Key behavior:

- Reads target from `zone.preparedTargetX/Y`.
- Finds **valid stance tiles**: tiles adjacent to the target that:
  - Are not blocked.
  - Are already explored or currently have the player.
- Runs BFS from the player’s current tile to **any stance tile**, allowed to traverse only:
  - Non-blocked tiles that are explored or have the player.

Edge cases:

- If there is no player position yet → returns `null` (exploration still works, but without movement).
- If no stance tile is reachable using explored tiles → returns `null` (no movement; we still reveal after explore delay when properly handled).

Return value:  
Array of `{ x, y }` steps that lead to a stance tile next to the target, **excluding** the starting tile.  
This guarantees the **character ends up adjacent to the target tile, not on it** during the exploration timer.

### 5.4. Explore delay: `startZoneExploreDelay(onReveal)`

This function is called **after movement finishes** (or immediately if there is no movement).

Behavior:

1. Read the current prepared target (`preparedTargetX/Y`).
2. Clear any previous `isActiveExplore` flags.
3. Set `tile.isActiveExplore = true` on the target tile → this is what makes the tile blink.
4. Re-render the zone UI.
5. Start a delay (currently 1–3 seconds). When the timer completes, call `onReveal()`.

`cancelZoneExploreDelay()` cancels any running delay.

### 5.5. Auto-explore loop

- `scheduleNextZoneExplorationTick()`  
  - Waits a small idle delay (~200 ms) and then calls `beginZoneExplorationCycle()`.

- `beginZoneExplorationCycle()`  
  1. Check if zone is already fully explored → stop if so.
  2. Call `ZoneDebug.prepareNextExplorationTile(currentZone)`.
  3. Re-render UI.
  4. Compute path with `findPathToPreparedTile(currentZone)`.
  5. If no path:
     - Call `startZoneExploreDelay(() => runZoneExplorationTick())` (no movement, just explore delay + reveal).
  6. If there is a path:
     - Call `startZoneMovement(path, () => { startZoneExploreDelay(() => runZoneExplorationTick()); })`.

- `runZoneExplorationTick()`  
  - Double-checks if the zone is finished; if finished, stop exploration and call `onZoneFullyExplored()`.
  - Otherwise:
    - Call `revealNextTileWithMessageAndUI()` to actually flip the tile and move the player onto it.
    - `revealNextTileWithMessageAndUI()` also adds a random exploration message and re-renders UI.
    - Finally, `scheduleNextZoneExplorationTick()` to start the next cycle.

- `startZoneExplorationTicks()` / `stopZoneExplorationTicks()`  
  - Start/stop the auto exploration system.
  - Stop also cancels movement and any running explore delay and clears blinking tiles.

### 5.6. Manual explore: `startZoneManualExploreOnce()`

Flow for the **“Explore Next Tile”** button:

1. Guard rails: do nothing if auto is active, movement is active, or zone is already finished.
2. Compute stats; if complete, show a message and early-exit.
3. Call `ZoneDebug.prepareNextExplorationTile(currentZone)`.
4. Re-render UI.
5. Compute path via `findPathToPreparedTile(currentZone)`.
6. Mark `zoneManualExplorationActive = true`.
7. Define `finishManualExplore` which will:
   - Set `zoneManualExplorationActive = false`.
   - Call `revealNextTileWithMessageAndUI()`.
8. If no path:
   - Call `startZoneExploreDelay(finishManualExplore)` directly.
9. If there is a path:
   - Call `startZoneMovement(path, () => { startZoneExploreDelay(finishManualExplore); })`.

The net result is that a single manual click executes **exactly one full cycle**:
> choose target → walk adjacent → explore delay + blink → reveal → stop.

---

## 6. UI Behavior (zones.ui.js)

### 6.1. Rendering character and tiles

`buildZoneGridString(zone)`:

- Derives character glyphs per tile:
  - `#` for `kind === "blocked"`.
  - `L` for `kind === "locked"` (gate).
  - `?` for unexplored walkable tiles.
  - `.` for explored walkable tiles.
- Applies base CSS class `"zone-cell"` to each `<span>`.
- If `tile.isActiveExplore && !tile.explored`, adds `"zone-cell-exploring"` class, which triggers the **blinking explore animation**.
- Then checks if the player is on this tile (`hasPlayer` or `zone.playerX/Y` depending on current implementation) and draws the `☺` character instead of the tile glyph.

Important: with the current movement system, **the blinking tile is a `?` tile adjacent to the character**, not the tile the character stands on. That ensures the character itself does not blink, only the target tile does.

### 6.2. Status and controls

- Zone status text now reflects:
  - Not in zone / Exploring (Auto) / Exploring (Manual) / Idle / Completed.
- Buttons:
  - **Explore Next** → `startZoneManualExploreOnce()`.
  - **Explore (Auto)** → `startZoneExplorationTicks()`.
  - **Stop** → `stopZoneExplorationTicks()`.

The finish menu remains (STAY / LEAVE), with STAY still effectively a no-op other than logging.

---

## 7. What’s Implemented vs Still TODO

### 7.1. Implemented QoL items (from the original 10-point list)

1. **Character sprite/symbol (`☺`) shown on zone grid**  
   - Yes. The character moves tile-by-tile as exploration progresses.

2. **Blinking animation for tile being explored**  
   - Yes. The tile currently under exploration (target `?`) is flagged with `isActiveExplore` and rendered with the `zone-cell-exploring` CSS class.
   - Character stands **next to** this tile while it blinks; only later moves onto it.

3. **Smarter exploration path (random / natural walk instead of strict sequential)**  
   - Yes (first pass).  
   - `prepareNextExplorationTile` + `tileHasExploredOrPlayerNeighbor` implement a frontier-based, neighbor-prioritized exploration order.  
   - Combined with pathfinding that walks only over explored tiles, this produces a **natural wandering behavior** instead of simple row-by-row scanning.

4. **Exploration pacing and feel**  
   - Yes (first pass).  
   - Movement speed is configurable by tiles-per-second.  
   - Exploration delay (per-tile) is currently random 1–3 seconds and separated from movement; can be tuned or moved to config later.

### 7.2. Known TODOs (from original user list; not yet implemented or only partially addressed)

These should be handled in future QoL passes or adjacent branches:

1. **Remove the STAY button in the zone view**
   - Currently STAY logs to console and otherwise does nothing.  
   - TODO: remove and adjust layout accordingly.

2. **Make the "L" tile invisible until at least one adjacent tile has been explored**
   - Currently, `L` tiles are shown directly based on layout.
   - TODO: hide `L` behind a "?" until an adjacent tile is explored, then reveal it.

3. **Add a "view distance" mechanic (3×3 area around player)**
   - Currently, exploration reveals individual tiles based on exploration logic; there is no concept of **FOV/view distance** beyond “explored vs unexplored”.
   - TODO: introduce a view-distance system where exploring / moving reveals tiles in a radius around the player, and make it configurable for future features like torches, light sources, etc.
   - Note: All tiles within the view distance will count as explored when revealed, not only the one "targeted" tile.

4. **Zone Completed text visibility**
   - Original request: only show “Zone Completed” when 100% explored.
   - Check current UI behavior and adjust if necessary (may already be correct depending on existing `getZoneStatusText` logic vs `zoneStatusEl`).

5. **Make the "L" tile only clickable after it has been discovered AND exploration is idle AND character position is adjacent to the "L" tile**
   - UI currently allows clicking `L` if visible and belonging to a locked region.  
   - TODO: add checks so the click is respected only when:
     - tile is “discovered” (whatever final definition is), and
     - no exploration (auto or manual) is currently in progress, and
     - player sprite/object is near the "L".

6. **Mark all tiles with "?" (including blocked tiles) until explored**
   - Current render logic shows `#` for blocked tiles right away.
   - TODO: change rendering so all tiles initially show as `?` and only reveal their actual type (`#`, `.`, `L`) after being explored (or revealed by view distance).

7. **World map coordinate system change**
   - Original objective: set tutorial zone to `(0, 0)` and use:
     - North: `Y + 1`
     - East: `X + 1`
     - South: `Y - 1`
     - West: `X - 1`
   - TODO: update world map generation, movement, and UI representation accordingly.

---

## 8. Notes for the Next Assistant

- The current implementation is **good enough to feel like a proper “walk → inspect → reveal” loop**, but many numbers (movement speed, explore delay) are **hardcoded** and should later be exposed through `GAME_CONFIG` for balancing.
- Pathfinding intentionally avoids going through unknown `?` tiles to keep movement grounded in what the player has already explored.
- The **separation of responsibilities** is important:
  - `zones.core.js` – low-level tile/zone logic & debug helpers.
  - `game.js` – high-level exploration loop, timers, movement and UI orchestration.
  - `zones.ui.js` – purely visual; reads tile flags and renders them.
- When you add **view distance**, you’ll likely need:
  - Additional per-tile state like `tile.discovered` vs `tile.explored` or similar.
  - Hooks in movement and reveal functions to update “seen” tiles in a radius around `hasPlayer`.

This branch is now in a stable place to either:

1. Finish the remaining QoL items in small, isolated steps, or  
2. Consider this “good enough for now” and move on to **0.0.70d – Dynamic Events**, knowing that movement + exploration feel is already significantly improved over the original sequential scanner.
