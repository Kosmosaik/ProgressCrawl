# ProgressCrawl — Technical Architecture Map
## How Zone Templates, World Map, Spawn Tables, and Content Systems Connect

This document explains, at a **technical level**, how the following parts of the project connect:

- **Zone templates & zone generation scripts**
- **World map tiles & discovery flow**
- **Spawn tables & difficulty**
- **Content definition + placement + interactions + persistence**

It’s intended for the **next assistant** (or future-you) to quickly understand where to make changes and what not to break.

---

## 1) High-level Data Flow

### 1.1 World → Zone → Content (runtime)
1. **World map exists** as a grid of *world tiles* (some UNKNOWN, some DISCOVERED).
2. When a tile becomes **DISCOVERED**, it gets initialized with:
   - `templateId` (which zone template to use)
   - `biome`, `era` (context)
   - `difficultyRating` (numeric, generated by distance weighting)
   - `seed` (determinism)
   - `zoneId` (unique zone instance id)
3. When the player **enters** a tile’s zone:
   - The zone is created/generated from the template (`ZONE_TEMPLATES[templateId]`)
   - Zone content is populated deterministically (`populateZoneContent`)
   - Exploration state + content state are applied from deltas (if any)
4. When the player explores tiles and interacts:
   - **Explored tiles** are recorded and persisted
   - Content interactions create **content deltas** (depleted/opened/defeated/discovered)
   - Loot is awarded to inventory
   - Autosave persists state

---

## 2) Key Registries and “Source of Truth” Objects

### 2.1 Zone Templates
**Location:** `scripts/zones/zones.data.js`

- `ZONE_TEMPLATES`: defines the *layout identity* of a zone type:
  - generator type and config
  - size parameters
  - default weather state
  - other static template metadata

**Important rule:**
- Templates are **layout/identity only**.
- Zone instance difficulty is **not** “baked into” templates.
- The world tile supplies `difficultyRating`.

### 2.2 World Tiles (World Map State)
**Locations:** `scripts/worldmap/worldmap.core.js`, `scripts/worldmap/worldmap.slots.js`

World tiles store the per-instance context used downstream:
- `tile.zoneId` (zone instance identifier)
- `tile.templateId`
- `tile.biome`
- `tile.era`
- `tile.difficultyRating` (numeric 1–10+)
- `tile.seed`
- `tile.status` (UNKNOWN/DISCOVERED/VISITED)

### 2.3 Content Definitions
**Location:** `scripts/content/content.defs.js`

- `PC.content.DEFS` contains content definitions by kind:
  - `resourceNodes`
  - `entities`
  - `pois`
  - `locations`

A “def” is *static data*:
- id, name
- glyph/marker
- loot table id(s) or loot references (as applicable)
- tags (era/biome/difficulty ranges as metadata for later filters)

### 2.4 Loot Tables
**Location:** `scripts/content/content.lootTables.js`

- `PC.content.LOOT_TABLES` defines item bundles and weights.
- Current system: used by interaction handlers to produce loot.

**Important note:**
- Loot weighting is separate from difficulty.
- Difficulty affects *what spawns* via spawn tables, not necessarily what loot rolls (unless later extended).

### 2.5 Spawn Tables
**Location:** `scripts/content/content.spawnTables.js`

- `PC.content.SPAWN_TABLES.byContext`: the primary procedural system.
  - Indexed by **biome → era → list of difficultyRange entries**
  - Each entry includes counts (density or countRange) and weighted defs per kind.
- `PC.content.SPAWN_TABLES.byTemplate`: reserved for exceptions (tutorial/special handcrafted zones).
  - Avoid using this for normal procedural spawning.

**Important rule:**
- Spawn tables **do not generate difficulty**.
- They *consume* `difficultyRating` from the world tile to select the correct table entry.

### 2.6 Content Deltas (Persistence)
**Location:** `scripts/content/content.deltas.js`

- Stores changes made by the player to a specific zone instance:
  - explored tiles
  - node depleted
  - entity defeated
  - poi opened/inspected
  - location discovered
- Intended to persist in save files.

---

## 3) Core Connection Points (Where Systems Meet)

### 3.1 World tile initialization (difficulty + template)
**Location:** `scripts/worldmap/worldmap.slots.js`

Key concept:
- On tile discovery, initialization assigns:
  - templateId (usually the default procedural template for now)
  - difficultyRating using distance-based function (`pickDifficultyForDistance(distance)`)

This is the **upstream** source for difficulty used by spawn tables.

### 3.2 Zone creation (template → grid)
**Location:** `scripts/zones/zones.core.js`

Responsibilities:
- Create a `zone` object with grid/tiles.
- Generate terrain via generator specified in template (`generatorConfig`).
- Store `zone.id`, `zone.width`, `zone.height`, tile data, entry point, etc.

**Critical hook:**
- `initializeZoneContent(zone, def)` is the *single lifecycle hook* used to populate content.
- This hook calls into content system to populate deterministically and apply deltas.

### 3.3 Content population (spawn tables → instances placed)
**Location:** `scripts/content/content.populate.js`

Responsibilities:
- Resolve which spawn table applies:
  1. Template-specific override (only for special zones)
  2. Context-based table by biome/era and `difficultyRating` matching `difficultyRange`
- Compute counts:
  - Some kinds scale with zone size (walkable tiles)
  - Some kinds remain mostly static (POIs/Locations)
- Pick definitions using weighted selection (RNG utilities).
- Place content instances on valid tiles (using placement helpers).
- Create `zone.content` arrays with instances:
  - each instance has `id/defId/x/y/state/...`

### 3.4 Placement helpers (candidate tiles + constraints)
**Location:** `scripts/content/content.place.js`

Responsibilities:
- Determine walkable/candidate tiles.
- Provide helpers:
  - adjacency checks, distances, wall checks
  - prevent overlap using used-set keys (`"x,y"`)
- Used by `content.populate.js` placement functions.

### 3.5 Interaction routing (tile click → confirm → action)
**Locations:**
- UI click routing: `scripts/zones/zones.ui.js`
- Modal confirm UI: `scripts/game/game.ui.modal.js`
- Interaction logic: `scripts/content/content.interact.js`

Flow:
1. Player clicks a tile that has visible content.
2. UI shows a modal with action buttons based on content kind:
   - Harvest/Kill/Inspect/Enter
3. Confirm calls `PC.api.zone.interactAt(x, y)` (or equivalent entrypoint).
4. `content.interact.js`:
   - checks what instance is present
   - ensures it’s interactable
   - rolls loot from loot tables
   - sets instance state (depleted/defeated/opened/discovered)
   - writes deltas for persistence
   - triggers autosave
   - causes UI refresh

### 3.6 Inventory integration (loot → inventory + unlock)
**Locations:**
- Inventory core: `scripts/inventory/inventory.core.js`
- UI unlock helper: `scripts/game/game.ui.panels.js`

Flow:
- Loot awarding uses `addToInventory(...)`
- `addToInventory(...)` triggers:
  - inventory render
  - inventory unlock helper (ensures inventory button appears)
  - save (if configured)

---

## 4) Difficulty: Where It Lives and How It’s Used

### 4.1 Authority
- **World tile** is authoritative: `tile.difficultyRating`
- **Zone template** difficulty is legacy/fallback only (prefer removing or renaming to `defaultDifficulty` if still present).

### 4.2 Spawn resolution
- `content.populate.js` selects a spawn table entry by matching:
  - `biome`
  - `era`
  - `difficultyRating` within `difficultyRange: [min, max]`

This supports:
- exact difficulty tables: `[k, k]`
- bands/ranges: `[1, 3]`, `[4, 6]`, `[7, 10]`
- future expansion beyond 10.

---

## 5) Recommended Authoring Workflow (Adding New Biomes / Zone Types)

### 5.1 Add a new procedural zone type (normal case)
1. Add a **template** in `zones.data.js` (layout/generator).
2. Ensure worldmap selection can assign this `templateId` (currently a simple default; later: choose from pools by distance/region).
3. Add **byContext spawn tables** for the new biome/era/difficulty ranges in `content.spawnTables.js`.
4. Add any needed content defs + loot tables.

You should **not** have to add the same id in 4 places:
- centralize IDs using your registry/ids file if available.

### 5.2 Add a special handcrafted zone (tutorial/boss/story)
1. Create/keep a fixed `zoneId` in zone definitions.
2. Use `SPAWN_TABLES.byTemplate[zoneId or templateId]` for tiny controlled counts **or** define fixed placed content later.
3. Avoid mixing handcrafted exceptions into the main procedural byContext tables.

---

## 6) Common Pitfalls / Rules for Future Work

### 6.1 Do not encode difficulty into template IDs
Avoid:
- `primitive_forest_d1`, `primitive_forest_d2`, ...

Prefer:
- template id `primitive_forest`
- instance difficulty on world tile `difficultyRating: 1..10`

### 6.2 Keep `byTemplate` for exceptions only
- Procedural spawning should come from `byContext`.
- Template overrides should only be for tutorial/special zones.

### 6.3 Keep a single “zone lifecycle hook”
- Do not scatter content population across multiple places.
- `initializeZoneContent(...)` should remain the single call site that:
  - creates zone.content
  - populates deterministically
  - applies deltas

### 6.4 Persistence must be delta-based
- Do not regenerate player-changed content.
- Store:
  - explored tiles
  - per-instance state changes
- Apply deltas on enter/load consistently.

---

## 7) Quick “Where Do I Change X?” Map

- **Change zone layouts / sizes:** `zones.data.js` (template generator config)
- **Change difficulty progression:** `worldmap.slots.js` (`pickDifficultyForDistance`)
- **Change what spawns where:** `content.spawnTables.js` (`byContext`)
- **Add new content types/defs:** `content.defs.js`
- **Change placement rules:** `content.place.js` and placement logic in `content.populate.js`
- **Change interaction behavior/loot:** `content.interact.js` + `content.lootTables.js`
- **Change persistence rules:** `content.deltas.js` + save/load files
- **Change UI rendering markers:** `zones.ui.js` + modal UI scripts/CSS

---

End of document.
